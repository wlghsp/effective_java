# Item 85 자바 직렬화의 대안을 찾으라 

--------------------------------------------

1997년에 자바에 처음으로 직렬화가 도입되었다. 

직렬화의 단점도 많지만 장점이 이를 압도할것으로 생각해왔지만, 그 반대였다. 

보안 문제는 심각하고, 그 취약점들이 십 년 이상 심각하게 악용됨. 

<hr>

### 직렬화의 근본적인 문제점

> 공격범위가 너무 넓고 지속적으로 더 넓어져 방어하기 어렵다. 

ObjectInputStream의 readObject메서드를 호출하면서 객체 그래프가 역직렬화되기 때문이다. 

readObject 메서드는 (Serializable인터페이스를 구현했다면) 클래스패스 안의 거의 모든 타입의 객체를 만들어 낼 수 있는, 

사실상 맘법 같은 생성자다. 

바이트 스트림을 역직렬화하는 과정에서 이 메서드는 그 타입들 안의 모든 코드를 수행할 수 있다. 

이 말인즉슨, 그 타입들의 코드 전체가 공격 범위에 들어간다는 뜻이다. 

<hr>

자바의 표준 라이브러리나 아파치 커먼즈 컬렉션 같은 서드파티 라이브러리는 물론 애플리케이션 자신의 클래스들도 

공격 범위에 포함된다. 

관련한 모든 모범 사례를 따르고 모든 직렬화 가능 클래스들을 공격에 대비하도록 작성한다 해도, 여러분의 애플리케이션은 여전히 취약할 수 있다. 

<hr>

CERT 조정 센터의 기술 관리자인 로버트 시커드의 말을 들어보자. 

> 자바의 역직렬화는 명백하고 현존하는 위험이다. 이 기술은 지금도 애플리케이션에서 직접 혹은, 자바 하부 시스템(RMI(Remote Method Invocation)), 
> JMX(Java Management Extension), JMS(Java Messaging System)을 통해 간접적으로 쓰이고 있기 때문이다. 
> 신뢰할 수 없는 스트림을 역직렬화하면 원격 코드 실행(remote code execution, RCE), 서비스 거부(denial-of-service, DoS)등의 공격으로 이어질 수 있다. 
> 잘못한 게 아무것도 없는 애플리케이션이라도 이런 공격에 취약해질 수 있다. 

<hr>

역직렬화에 시간이 오래 걸리는 짧은 스트림을 역직렬화하는 것만으로도 서비스 거부 공격에 쉽게 노출될 수 있다. 

이런 스트림을 역직렬화 폭탄(deserializatoin bomb)이라고 한다. 여기 바우터르쿠카르츠가 HashSet과 문자열만 사용해 만든 예를 준비했다. 


코드 85-1 역직렬화 폭탄 - 이 스트림의 역직렬화는 영원히 계속된다.

``` java
static byte[] bomb() {
    Set<Object> root = new HashSet<>();
    Set<Object> s1 = root;
    Set<Object> s2 = new HashSet<>();
    for (int i = 0; i < 100; i++) {
        Set<Object> t1 = new HashSet<>();
        Set<Object> t2 = new HashSet<>();
        t1.add("foo"); // t1을 t2와 다르게 만든다. 
        s1.add(t1);
        s1.add(t2);
        s2.add(t1);
        s2.add(t2);
    }
    return serialize(root); // 간결하게 하기 위해 이 메서드의 코드는 생략함
}
```

그렇다면 이 문제들을 어떻게 대처해야 할까? 

애초에 신뢰할 수 없는 바이트 스트림을 역직렬화하는 일 자체가 스스로를 공격에 노출하는 행위다. 

> 따라서 직렬화 위험을 회피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것이다. 


> 여러 분이 작성하는 새로운 시스템에서 자바 직렬화를 써야 할 이유는 전혀 없다. 



### 핵심 정리
- 직렬화는 위험하니 피해야 한다.
- 시스템을 밑바닥부터 설계한다면 JSON이나 프로토콜 버퍼 같은 대안을 사용하자. 
- 신뢰할 수 없는 데이터는 역직렬화하지 말자. 
- 꼭 해야한다면 객체 역직렬화 필터링을 사용하되, 이마저도 모든 공격을 막아줄 수는 없음을 기억하자. 
- 클래스가 직렬화를 지원하도록 만들지 말고, 꼭 그렇게 만들어야 한다면 정말 신경 써서 작성해야 한다. 